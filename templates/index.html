<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¶³å½©åˆ†æ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
        }
        
        .header h1 {
            color: #333;
            margin-bottom: 20px;
            font-size: 32px;
        }
        
        .controls {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }
        
        .btn-success {
            background: #48bb78;
            color: white;
        }
        
        .btn-success:hover {
            background: #38a169;
        }
        
        select {
            padding: 10px 15px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            background: white;
        }
        
        .nav-tabs {
            display: flex;
            margin-bottom: 20px;
            background: white;
            padding: 5px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }
        
        .nav-tab {
            flex: 1;
            text-align: center;
            padding: 12px;
            cursor: pointer;
            border-radius: 8px;
            font-weight: 500;
            color: #718096;
            transition: all 0.3s ease;
        }
        
        .nav-tab.active {
            background: #667eea;
            color: white;
            font-weight: 600;
            box-shadow: 0 2px 4px rgba(102, 126, 234, 0.3);
        }
        
        .nav-tab:hover:not(.active) {
            background: #f7fafc;
            color: #4a5568;
        }

        .matches-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            font-size: 13px;
        }
        .matches-table th, .matches-table td {
            padding: 10px 6px;
            border-bottom: 1px solid #f0f0f0;
            color: #2d3748;
            vertical-align: middle;
        }
        .matches-table thead th {
            background: #f7fafc;
            color: #4a5568;
            font-weight: 600;
            white-space: nowrap;
            text-align: center;
            padding: 12px 6px;
        }
        .matches-table tbody td {
            text-align: center;
        }
        .matches-table tbody tr:hover {
            background: #f7fafc;
            cursor: pointer;
        }

        /* Column Specifics */
        /* 1. Match Info (åœºæ¬¡/è”èµ›/æ—¶é—´ åˆå¹¶) */
        .matches-table th:nth-child(1), .matches-table td:nth-child(1) { 
            width: 95px;
            text-align: left;
            padding-left: 8px;
        }
        .matches-table td:nth-child(1) .match-info {
            line-height: 1.3;
        }
        .matches-table td:nth-child(1) .match-info .match-num {
            font-size: 10px;
            color: #a0aec0;
            margin-bottom: 1px;
        }
        .matches-table td:nth-child(1) .match-info .match-league {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 1px 6px;
            border-radius: 8px;
            font-size: 10px;
            font-weight: 500;
            margin-bottom: 1px;
        }
        .matches-table td:nth-child(1) .match-info .match-datetime {
            font-size: 10px;
            color: #718096;
        }
        /* 2. Home Team */
        .matches-table th:nth-child(2), .matches-table td:nth-child(2) { 
            text-align: right; 
            font-weight: 600;
            max-width: 100px;
            font-size: 12px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        /* 3. Score */
        .matches-table th:nth-child(3), .matches-table td:nth-child(3) { 
            width: 50px; 
            font-weight: bold; 
            font-size: 12px;
            color: #667eea; 
            white-space: nowrap; 
        }
        /* 4. Away Team */
        .matches-table th:nth-child(4), .matches-table td:nth-child(4) { 
            text-align: left; 
            font-weight: 600;
            max-width: 100px;
            font-size: 12px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        /* 5. Status */
        .matches-table th:nth-child(5), .matches-table td:nth-child(5) { 
            width: 55px;
            min-width: 55px;
            white-space: nowrap;
        }
        .matches-table td:nth-child(5) .status {
            font-size: 11px;
            padding: 3px 8px;
        }
        /* 6, 7, 8 Odds */
        .matches-table th:nth-child(6), .matches-table td:nth-child(6),
        .matches-table th:nth-child(7), .matches-table td:nth-child(7),
        .matches-table th:nth-child(8), .matches-table td:nth-child(8) {
            font-size: 12px;
            min-width: 110px;
            line-height: 1.3;
        }
        .matches-table td:nth-child(6) div,
        .matches-table td:nth-child(7) div,
        .matches-table td:nth-child(8) div {
            margin: 1px 0;
            white-space: nowrap;
        }
        
        /* AIé¢„æµ‹åˆ—è®¾ç½®æœ€å°å®½åº¦ */
        .matches-table th:nth-child(10),
        .matches-table td:nth-child(10) {
            min-width: 120px;
            max-width: 160px;
            font-size: 12px;
        }
        
        .match-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transition: transform 0.3s, box-shadow 0.3s;
            cursor: pointer;
        }
        
        .match-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.3);
        }
        
        .match-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .league {
            background: #667eea;
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 500;
        }
        
        .match-time {
            color: #718096;
            font-size: 13px;
        }
        
        .teams {
            margin: 20px 0;
        }
        
        .team-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 15px 0;
        }
        
        .team-name {
            font-size: 18px;
            font-weight: 600;
            color: #2d3748;
            flex: 1;
        }
        
        .score {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
            min-width: 40px;
            text-align: center;
        }
        
        .vs {
            color: #cbd5e0;
            font-weight: bold;
            margin: 5px 0;
            text-align: center;
        }
        
        .match-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px solid #f0f0f0;
        }
        
        .status {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 500;
        }
        
        .status.finished {
            background: #48bb78;
            color: white;
        }
        
        .status.live {
            background: #f56565;
            color: white;
        }
        
        .status.upcoming {
            background: #edf2f7;
            color: #4a5568;
        }
        
        .odds-info {
            color: #718096;
            font-size: 13px;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: white;
            font-size: 18px;
        }
        
        .empty {
            text-align: center;
            padding: 60px 20px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .empty-icon {
            font-size: 60px;
            margin-bottom: 20px;
        }
        
        .empty-text {
            color: #718096;
            font-size: 18px;
        }
        
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 20px;
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .pagination button {
            padding: 8px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            background: white;
            color: #4a5568;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
        }
        
        .pagination button:hover:not(:disabled) {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        
        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .pagination .page-info {
            color: #4a5568;
            font-size: 14px;
            font-weight: 500;
        }
        
        .odds-hit {
            color: #e53e3e;
            font-weight: bold;
        }
        
        /* AIé¢„æµ‹æ ·å¼ */
        .prediction-cell {
            cursor: pointer;
            transition: background 0.2s;
            vertical-align: top;
        }
        
        .prediction-cell:hover {
            background: #f7fafc;
        }
        
        .pred-success {
            color: #48bb78;
            font-weight: 600;
        }
        
        .pred-warning {
            color: #f6ad55;
            font-weight: 600;
        }
        
        .pred-fail {
            color: #fc8181;
            font-weight: 600;
        }
        
        .pred-pending {
            color: #667eea;
            font-weight: 500;
        }
        
        /* æ¨ªå‘æ»šåŠ¨æ”¯æŒ */
        .table-wrapper { overflow-x: auto; -webkit-overflow-scrolling: touch; }
        .matches-table { min-width: 1100px; }
        
        /* å“åº”å¼è§†å›¾æ§åˆ¶ */
        .mobile-view { display: none; }
        .desktop-view { display: block; }
        
        @media (max-width: 768px) {
            .matches-grid {
                grid-template-columns: 1fr;
            }
            
            .header {
                padding: 15px;
            }

            .header h1 {
                font-size: 20px;
                margin-bottom: 10px;
            }

            .controls {
                flex-direction: row;
                flex-wrap: wrap;
                align-items: center;
                gap: 8px;
            }

            .controls .btn, 
            .controls select, 
            .controls input {
                padding: 6px 10px;
                font-size: 12px;
                height: 32px;
            }
            
            .stats-bar {
                flex-direction: column;
            }
            
            /* ç§»åŠ¨ç«¯åˆ‡æ¢ä¸ºå¡ç‰‡è§†å›¾ */
            .desktop-view { display: none; }
            .mobile-view { display: flex; flex-direction: column; gap: 15px; }
            
            .mobile-card {
                background: white;
                border-radius: 12px;
                padding: 15px;
                box-shadow: 0 4px 6px rgba(0,0,0,0.05);
                border: 1px solid #e2e8f0;
            }
            
            .m-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 12px;
                font-size: 12px;
                color: #718096;
            }
            
            .m-league {
                background: #667eea;
                color: white;
                padding: 2px 8px;
                border-radius: 4px;
                font-weight: 500;
            }
            
            .m-body {
                display: flex;
                align-items: center;
                justify-content: space-between;
                margin-bottom: 15px;
            }
            
            .m-team {
                flex: 1;
                font-weight: 600;
                font-size: 15px;
                color: #2d3748;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }
            
            .m-rank {
                color: #718096;
                font-size: 12px;
                font-weight: normal;
                margin-right: 4px;
            }
            
            .m-team.home { text-align: right; padding-left: 5px; }
            .m-team.away { text-align: left; padding-right: 5px; }
            
            .m-score-box {
                min-width: 80px;
                text-align: center;
                padding: 0 10px;
            }
            
            .m-score {
                font-size: 20px;
                font-weight: bold;
                color: #667eea;
                line-height: 1.2;
            }
            
            .m-status {
                font-size: 11px;
                color: #a0aec0;
            }
            
            .m-footer {
                border-top: 1px solid #f0f0f0;
                padding-top: 10px;
                font-size: 12px;
            }
            
            .m-odds-grid {
                display: grid;
                grid-template-columns: 1fr;
                gap: 8px;
                margin-bottom: 10px;
                background: #f8fafc;
                padding: 8px;
                border-radius: 6px;
            }
            
            .m-odds-item {
                display: flex;
                align-items: flex-start;
                font-size: 13px;
                line-height: 1.4;
            }
            
            .m-odds-label {
                background: #edf2f7;
                color: #4a5568;
                padding: 2px 6px;
                border-radius: 4px;
                margin-right: 8px;
                font-weight: 600;
                min-width: 24px;
                text-align: center;
                height: fit-content;
            }
            
            .m-odds-content {
                flex: 1;
                display: flex;
                flex-direction: column;
                color: #2d3748;
            }

            .m-odds-row-text {
                display: flex;
                gap: 8px;
            }
            
            .m-update-time {
                font-size: 11px;
                color: #718096;
                margin-top: 6px;
                text-align: left;
            }
            
            .m-actions {
                display: flex;
                gap: 8px;
                margin-top: 10px;
                justify-content: flex-end;
            }
            
            /* ç§»åŠ¨ç«¯åˆ†é¡µæ ·å¼è°ƒæ•´ */
            .pagination {
                padding: 10px;
                gap: 8px;
                flex-wrap: wrap;
            }
            
            .pagination button {
                padding: 6px 12px;
                font-size: 12px;
            }
            
            .pagination .page-info {
                font-size: 12px;
                width: 100%;
                text-align: center;
                order: -1;
                margin-bottom: 5px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>âš½ è¶³å½©åˆ†æ</h1>
            <div class="controls">
                <select id="leagueFilter">
                    <option value="">æ‰€æœ‰è”èµ›</option>
                </select>
                <input type="hidden" id="statusFilter" value="0">
                <button class="btn btn-primary" onclick="loadMatches()">ğŸ”„ åˆ·æ–°æ•°æ®</button>
                <input type="date" id="datePicker" style="padding: 10px 15px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px;" onchange="loadMatches(1)"> <button class="btn btn-success" onclick="crawlNewData()">ğŸ“¥ çˆ¬å–æ–°æ•°æ®</button>

                <button class="btn btn-success" onclick="reviewFinished()" style="background:#48bb78;">ğŸ§¾ å¤ç›˜å®Œåœº</button>
                <button class="btn btn-success" onclick="location.href='/daily_recommendations'" style="background:linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">ğŸ“Š æ¯æ—¥æ¨è</button>
                <button class="btn btn-success" onclick="location.href='/lower_plate'" style="background:linear-gradient(135deg, #11998e 0%, #38ef7d 100%);">ğŸ² ä¸‹ç›˜ç­›é€‰</button>
                <button class="btn btn-success" onclick="location.href='/odds_filter'" style="background:linear-gradient(135deg, #fc4a1a 0%, #f7b733 100%);">ğŸ“ˆ èµ”ç‡ç­›é€‰</button>
                <a href="/my_picks" class="btn btn-success" style="background:linear-gradient(135deg, #00b09b 0%, #96c93d 100%);">ğŸ¯ æˆ‘çš„é€‰æ‹©</a>
            </div>
        </div>
        
        <div class="nav-tabs">
            <div class="nav-tab active" onclick="switchTab('0', this)">æœªå¼€å§‹</div>
            <div class="nav-tab" onclick="switchTab('1', this)">è¿›è¡Œä¸­</div>
            <div class="nav-tab" onclick="switchTab('2', this)">å·²å®Œåœº</div>
            <div class="nav-tab" onclick="switchTab('', this)">å…¨éƒ¨</div>
        </div>
        
        <div id="crawlLogs" style="display: none;"></div>
        <div id="matchesContainer">
            <div class="loading">åŠ è½½ä¸­...</div>
        </div>
        <div id="paginationContainer"></div>
    </div>

    <script>
        // è·å–æˆ–ç”Ÿæˆè®¾å¤‡ID
        function getDeviceId() {
            let deviceId = localStorage.getItem('football_device_id');
            if (!deviceId) {
                // ç”Ÿæˆç®€å•çš„éšæœºID
                deviceId = 'user_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now();
                localStorage.setItem('football_device_id', deviceId);
            }
            return deviceId;
        }

        let allMatches = [];
        let currentPage = 1;
        let totalPages = 1;
        let pageSize = 50;
        
        // é¡µé¢åŠ è½½æ—¶è·å–æ•°æ®
        window.onload = function() {
            // è®¾ç½®æ—¥æœŸé€‰æ‹©å™¨é»˜è®¤ä¸ºä»Šå¤©
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            document.getElementById('datePicker').value = `${year}-${month}-${day}`;
            
            loadMatches();
            loadLeagues();
        };
        
        function switchTab(status, element) {
            document.getElementById('statusFilter').value = status;
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            element.classList.add('active');
            loadMatches(1);
        }

        // åŠ è½½æ¯”èµ›æ•°æ®
        async function loadMatches(page = 1) {
            try {
                const league = document.getElementById('leagueFilter').value;
                const status = document.getElementById('statusFilter').value;
                const date = document.getElementById('datePicker').value;
                
                let url = `/api/matches?page=${page}&page_size=${pageSize}`;
                if (league) url += `&league=${encodeURIComponent(league)}`;
                if (status) url += `&status=${encodeURIComponent(status)}`;
                if (date) url += `&date=${encodeURIComponent(date)}`;
                
                const response = await fetch(url);
                const result = await response.json();
                
                if (result.success) {
                    allMatches = result.data;
                    currentPage = result.page;
                    totalPages = result.total_pages;
                    displayMatches(allMatches);
                    renderPagination(result);
                } else {
                    showEmpty('åŠ è½½å¤±è´¥');
                }
            } catch (error) {
                console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
                showEmpty('åŠ è½½å¤±è´¥: ' + error.message);
            }
        }
        
        // æ˜¾ç¤ºæ¯”èµ›åˆ—è¡¨
        function displayMatches(matches) {
            const container = document.getElementById('matchesContainer');
            
            if (!matches || matches.length === 0) {
                showEmpty('æš‚æ— æ¯”èµ›æ•°æ®');
                return;
            }
            
            const mobileCardsArr = [];
            const rows = matches.map(match => {
                const score = (match.home_score && match.away_score && match.home_score !== '-' && match.away_score !== '-')
                    ? `${match.home_score}-${match.away_score}`
                    : (match.handicap || '-');
                
                // è®¡ç®—å‘½ä¸­é€»è¾‘ï¼ˆä»…å®Œåœºæ¯”èµ›ï¼‰
                let euroResult = null;  // 'win', 'draw', 'lose'
                let asianResult = null; // 'home', 'away'
                let ouResult = null;    // 'over', 'under'
                
                if (match.status === 2 && match.home_score && match.away_score && match.home_score !== '-' && match.away_score !== '-') {
                    try {
                        const home = parseInt(match.home_score);
                        const away = parseInt(match.away_score);
                        if (!isNaN(home) && !isNaN(away)) {
                            // æ¬§èµ”ç»“æœ
                            if (home > away) euroResult = 'win';
                            else if (home < away) euroResult = 'lose';
                            else euroResult = 'draw';
                            
                            // äºšç›˜ç»“æœï¼ˆéœ€è¦è§£æç›˜å£ï¼‰
                            const handicap = match.asian_current_handicap || match.asian_initial_handicap;
                            if (handicap) {
                                let handicapValue = 0;
                                if (handicap.includes('çƒ')) {
                                    const num = handicap.replace(/[^\d.]/g, '');
                                    handicapValue = parseFloat(num) || 0;
                                }
                                const adjustedHome = home + handicapValue;
                                if (adjustedHome > away) asianResult = 'home';
                                else if (adjustedHome < away) asianResult = 'away';
                            }
                            
                            // å¤§å°çƒç»“æœ
                            const total = parseFloat(match.ou_current_total || match.ou_initial_total);
                            if (!isNaN(total)) {
                                const actualTotal = home + away;
                                if (actualTotal > total) ouResult = 'over';
                                else if (actualTotal < total) ouResult = 'under';
                            }
                        }
                    } catch (e) {}
                }
                // æ³¨æ„ï¼šæ•°æ®åº“å­—æ®µå·²ä¿®æ­£
                const euroHasInitial = (match.euro_initial_win || match.euro_initial_draw || match.euro_initial_lose);
                const euroHasCurrent = (match.euro_current_win || match.euro_current_draw || match.euro_current_lose);
                const euroInitWin = euroResult === 'win' ? `<span class="odds-hit">${match.euro_initial_win || ''}</span>` : (match.euro_initial_win || '');
                const euroInitDraw = euroResult === 'draw' ? `<span class="odds-hit">${match.euro_initial_draw || ''}</span>` : (match.euro_initial_draw || '');
                const euroInitLose = euroResult === 'lose' ? `<span class="odds-hit">${match.euro_initial_lose || ''}</span>` : (match.euro_initial_lose || '');
                const euroCurrWin = euroResult === 'win' ? `<span class="odds-hit">${match.euro_current_win || ''}</span>` : (match.euro_current_win || '');
                const euroCurrDraw = euroResult === 'draw' ? `<span class="odds-hit">${match.euro_current_draw || ''}</span>` : (match.euro_current_draw || '');
                const euroCurrLose = euroResult === 'lose' ? `<span class="odds-hit">${match.euro_current_lose || ''}</span>` : (match.euro_current_lose || '');
                const euroInit = `${euroInitWin}/${euroInitDraw}/${euroInitLose}`;
                const euroCurr = `${euroCurrWin}/${euroCurrDraw}/${euroCurrLose}`;
                
                // é€šç”¨å‡½æ•°ï¼šè½¬æ¢ä¸ºæµ®ç‚¹æ•°
                const toFloat = (v) => {
                    const n = parseFloat(v);
                    return isNaN(n) ? null : n;
                };
                // é€šç”¨å‡½æ•°ï¼šæ ¼å¼åŒ–å˜åŠ¨
                const fmtChange = (diff) => diff == null ? 'â€”' : ((diff > 0 ? 'â†‘' : (diff < 0 ? 'â†“' : 'â€”')) + (diff !== 0 ? Math.abs(diff).toFixed(2) : ''));
                
                // èµ”ç‡æ›´æ–°æ—¶é—´
                const fmtTimeShort = (t) => {
                    if (!t) return '';
                    const full = formatUpdated(t);
                    return full === 'æœªçŸ¥' ? '' : full.substring(5); // MM-dd HH:mm
                };
                const euroTime = fmtTimeShort(match.euro_odds_update_time);
                const handicapTime = fmtTimeShort(match.odds_update_time);

                // è®¡ç®—æ¬§èµ”å˜åŠ¨ï¼ˆä¸»/å¹³/å®¢ï¼‰
                const euroWinInitF = toFloat(match.euro_initial_win);  // å®é™…åˆç›˜
                const euroWinCurrF = toFloat(match.euro_current_win);  // å®é™…å³æ—¶
                const euroDrawInitF = toFloat(match.euro_initial_draw);
                const euroDrawCurrF = toFloat(match.euro_current_draw);
                const euroLoseInitF = toFloat(match.euro_initial_lose);
                const euroLoseCurrF = toFloat(match.euro_current_lose);
                const euroWinDiff = (euroWinCurrF != null && euroWinInitF != null) ? (euroWinCurrF - euroWinInitF) : null;
                const euroDrawDiff = (euroDrawCurrF != null && euroDrawInitF != null) ? (euroDrawCurrF - euroDrawInitF) : null;
                const euroLoseDiff = (euroLoseCurrF != null && euroLoseInitF != null) ? (euroLoseCurrF - euroLoseInitF) : null;
                // æ¬§èµ”å˜åŠ¨é«˜äº®ï¼šè¶…è¿‡10%æ ‡çº¢
                const highlightEuroMove = (move, diff) => (diff != null && Math.abs(diff) >= 0.10 ? `<span class="odds-hit">${move}</span>` : move);
                const euroWinMove = highlightEuroMove(fmtChange(euroWinDiff), euroWinDiff);
                const euroDrawMove = highlightEuroMove(fmtChange(euroDrawDiff), euroDrawDiff);
                const euroLoseMove = highlightEuroMove(fmtChange(euroLoseDiff), euroLoseDiff);
                const euroMoveHtml = (euroHasInitial && euroHasCurrent) ? `<div style="color:#718096;font-size:12px;margin-top:4px;">ä¸»${euroWinMove} å¹³${euroDrawMove} å®¢${euroLoseMove}</div>` : '';
                const euro = (euroHasInitial || euroHasCurrent)
                    ? (euroHasInitial ? '<div>åˆ: ' + euroInit + '</div>' : '') + (euroHasCurrent ? '<div>å³: ' + euroCurr + '</div>' : '') + euroMoveHtml + (euroTime ? `<div style="color:#a0aec0;font-size:10px;margin-top:2px;">${euroTime}</div>` : '')
                    : 'â€”';
                const asianHasCurrent = (match.asian_current_home_odds || match.asian_current_handicap || match.asian_current_away_odds);
                const asianHasInitial = (match.asian_initial_home_odds || match.asian_initial_handicap || match.asian_initial_away_odds);
                const asianInitHome = asianResult === 'home' ? `<span class="odds-hit">${match.asian_initial_home_odds || ''}</span>` : (match.asian_initial_home_odds || '');
                const asianInitAway = asianResult === 'away' ? `<span class="odds-hit">${match.asian_initial_away_odds || ''}</span>` : (match.asian_initial_away_odds || '');
                const asianCurrHome = asianResult === 'home' ? `<span class="odds-hit">${match.asian_current_home_odds || ''}</span>` : (match.asian_current_home_odds || '');
                const asianCurrAway = asianResult === 'away' ? `<span class="odds-hit">${match.asian_current_away_odds || ''}</span>` : (match.asian_current_away_odds || '');
                const asianInit = `${asianInitHome}/${match.asian_initial_handicap || ''}/${asianInitAway}`;
                const asianCurr = `${asianCurrHome}/${match.asian_current_handicap || ''}/${asianCurrAway}`;
                // è®¡ç®—äºšç›˜å˜åŠ¨ï¼ˆä¸»æ°´/ç›˜å£/å®¢æ°´ï¼‰
                const parseHandicapNum = (h) => {
                    if (!h) return null;
                    const m = String(h).match(/\d+\.?\d*/);
                    return m ? parseFloat(m[0]) : null;
                };
                const homeInitF = toFloat(match.asian_initial_home_odds);
                const homeCurrF = toFloat(match.asian_current_home_odds);
                const awayInitF = toFloat(match.asian_initial_away_odds);
                const awayCurrF = toFloat(match.asian_current_away_odds);
                const handInitF = parseHandicapNum(match.asian_initial_handicap);
                const handCurrF = parseHandicapNum(match.asian_current_handicap);
                const homeDiff = (homeCurrF != null && homeInitF != null) ? (homeCurrF - homeInitF) : null;
                const awayDiff = (awayCurrF != null && awayInitF != null) ? (awayCurrF - awayInitF) : null;
                const handDiff = (handCurrF != null && handInitF != null) ? (handCurrF - handInitF) : null;
                const highlightMove = (move, diff, isOdds) => (isOdds && diff != null && Math.abs(diff) >= 0.10 ? `<span class="odds-hit">${move}</span>` : move);
                const homeMove = highlightMove(fmtChange(homeDiff), homeDiff, true);
                const awayMove = highlightMove(fmtChange(awayDiff), awayDiff, true);
                const handMove = fmtChange(handDiff);
                const moveHtml = (asianHasInitial && asianHasCurrent) ? `<div style="color:#718096;font-size:12px;margin-top:4px;">ä¸»${homeMove} ç›˜${handMove} å®¢${awayMove}</div>` : '';
                // ç›˜å£å˜åŠ¨æ ‡ç­¾
                const labelMap = {
                    'å‡ç›˜é™æ°´': { text: 'å‡ç›˜é™æ°´', color: '#e53e3e', bg: '#fed7d7' },
                    'å‡ç›˜å‡æ°´': { text: 'å‡ç›˜å‡æ°´', color: '#dd6b20', bg: '#feebc8' },
                    'é™ç›˜é™æ°´': { text: 'é™ç›˜é™æ°´', color: '#38a169', bg: '#c6f6d5' },
                    'é™ç›˜å‡æ°´': { text: 'é™ç›˜å‡æ°´', color: '#3182ce', bg: '#bee3f8' },
                    'å‡ç›˜': { text: 'å‡ç›˜', color: '#e53e3e', bg: '#fed7d7' },
                    'é™ç›˜': { text: 'é™ç›˜', color: '#38a169', bg: '#c6f6d5' },
                    'å‡æ°´': { text: 'å‡æ°´', color: '#dd6b20', bg: '#feebc8' },
                    'é™æ°´': { text: 'é™æ°´', color: '#3182ce', bg: '#bee3f8' },
                    'æ— å˜åŒ–': { text: 'â€”', color: '#a0aec0', bg: 'transparent' }
                };
                const asianLabel = match.asian_movement_label || '';
                const labelStyle = labelMap[asianLabel] || { text: 'â€”', color: '#a0aec0', bg: 'transparent' };
                const labelHtml = asianLabel && asianLabel !== 'æ— å˜åŒ–' 
                    ? `<div style="margin-top:4px;"><span style="font-size:11px;padding:2px 6px;border-radius:10px;background:${labelStyle.bg};color:${labelStyle.color};font-weight:600;">${labelStyle.text}</span></div>` 
                    : '';
                const asian = (asianHasInitial || asianHasCurrent)
                    ? (asianHasInitial ? '<div>åˆ: ' + asianInit + '</div>' : '') + (asianHasCurrent ? '<div>å³: ' + asianCurr + '</div>' : '') + moveHtml + labelHtml
                    : 'â€”';
                const ouHasCurrent = (match.ou_current_over_odds || match.ou_current_total || match.ou_current_under_odds);
                const ouHasInitial = (match.ou_initial_over_odds || match.ou_initial_total || match.ou_initial_under_odds);
                const ouInitOver = ouResult === 'over' ? `<span class="odds-hit">${match.ou_initial_over_odds || ''}</span>` : (match.ou_initial_over_odds || '');
                const ouInitUnder = ouResult === 'under' ? `<span class="odds-hit">${match.ou_initial_under_odds || ''}</span>` : (match.ou_initial_under_odds || '');
                const ouCurrOver = ouResult === 'over' ? `<span class="odds-hit">${match.ou_current_over_odds || ''}</span>` : (match.ou_current_over_odds || '');
                const ouCurrUnder = ouResult === 'under' ? `<span class="odds-hit">${match.ou_current_under_odds || ''}</span>` : (match.ou_current_under_odds || '');
                const ouInit = `${ouInitUnder}/${match.ou_initial_total || ''}/${ouInitOver}`;
                const ouCurr = `${ouCurrUnder}/${match.ou_current_total || ''}/${ouCurrOver}`;
                const ou = (ouHasInitial || ouHasCurrent)
                    ? (ouHasInitial ? '<div>åˆ: ' + ouInit + '</div>' : '') + (ouHasCurrent ? '<div>å³: ' + ouCurr + '</div>' : '')
                    : 'â€”';
                
                // è®©çƒæŒ‡æ•°
                const hiHasInitial = match.hi_initial_home_odds && match.hi_initial_draw_odds && match.hi_initial_away_odds;
                const hiHasCurrent = match.hi_current_home_odds && match.hi_current_draw_odds && match.hi_current_away_odds;
                const hiHandicap = match.hi_handicap_value || '';
                const hiInit = hiHasInitial ? `${match.hi_initial_home_odds}/${match.hi_initial_draw_odds}/${match.hi_initial_away_odds}` : '';
                const hiCurr = hiHasCurrent ? `${match.hi_current_home_odds}/${match.hi_current_draw_odds}/${match.hi_current_away_odds}` : '';
                // è®¡ç®—è®©çƒæŒ‡æ•°å˜åŠ¨ï¼ˆä¸»/å¹³/å®¢ï¼‰
                const hiHomeInitF = toFloat(match.hi_initial_home_odds);
                const hiHomeCurrF = toFloat(match.hi_current_home_odds);
                const hiDrawInitF = toFloat(match.hi_initial_draw_odds);
                const hiDrawCurrF = toFloat(match.hi_current_draw_odds);
                const hiAwayInitF = toFloat(match.hi_initial_away_odds);
                const hiAwayCurrF = toFloat(match.hi_current_away_odds);
                const hiHomeDiff = (hiHomeCurrF != null && hiHomeInitF != null) ? (hiHomeCurrF - hiHomeInitF) : null;
                const hiDrawDiff = (hiDrawCurrF != null && hiDrawInitF != null) ? (hiDrawCurrF - hiDrawInitF) : null;
                const hiAwayDiff = (hiAwayCurrF != null && hiAwayInitF != null) ? (hiAwayCurrF - hiAwayInitF) : null;
                // è®©çƒæŒ‡æ•°å˜åŠ¨é«˜äº®ï¼šè¶…è¿‡10%æ ‡çº¢
                const highlightHiMove = (move, diff) => (diff != null && Math.abs(diff) >= 0.10 ? `<span class="odds-hit">${move}</span>` : move);
                const hiHomeMove = highlightHiMove(fmtChange(hiHomeDiff), hiHomeDiff);
                const hiDrawMove = highlightHiMove(fmtChange(hiDrawDiff), hiDrawDiff);
                const hiAwayMove = highlightHiMove(fmtChange(hiAwayDiff), hiAwayDiff);
                const hiMoveHtml = (hiHasInitial && hiHasCurrent) ? `<div style="color:#718096;font-size:12px;margin-top:4px;">ä¸»${hiHomeMove} å¹³${hiDrawMove} å®¢${hiAwayMove}</div>` : '';
                const hi = (hiHasInitial || hiHasCurrent)
                    ? (hiHandicap ? `<div style="color:#667eea;font-weight:600;">${hiHandicap}</div>` : '') + 
                      (hiHasInitial ? '<div>åˆ: ' + hiInit + '</div>' : '') + 
                      (hiHasCurrent ? '<div>å³: ' + hiCurr + '</div>' : '') + 
                      hiMoveHtml
                    : 'â€”';
                // è®¡ç®—æ€»è¿›çƒæ•°
                let totalGoals = 'â€”';
                if (match.home_score && match.away_score && match.home_score !== '-' && match.away_score !== '-') {
                    try {
                        const home = parseInt(match.home_score);
                        const away = parseInt(match.away_score);
                        if (!isNaN(home) && !isNaN(away)) {
                            totalGoals = (home + away).toString();
                        }
                    } catch (e) {}
                }
                const statusClass = getStatusClass(match.status);
                const statusText = getStatusText(match.status);
                
                // AIé¢„æµ‹æ•°æ®ï¼ˆå¼‚æ­¥åŠ è½½ï¼‰
                const predictionId = `pred-${match.match_id}`;
                
                // çƒé˜Ÿåç§°å‰æ˜¾ç¤ºæ’å
                const showHomeRank = match.home_rank && parseInt(match.home_rank) >= 1;
                const showAwayRank = match.away_rank && parseInt(match.away_rank) >= 1;

                const homeDisplay = showHomeRank ? `<span style="color:#718096;font-size:11px;margin-right:4px;">[${match.home_rank}]</span>${match.home_team}` : (match.home_team || 'ä¸»é˜Ÿ');
                const awayDisplay = showAwayRank ? `<span style="color:#718096;font-size:11px;margin-right:4px;">[${match.away_rank}]</span>${match.away_team}` : (match.away_team || 'å®¢é˜Ÿ');
                
                // ç”Ÿæˆç§»åŠ¨ç«¯å¡ç‰‡
                const mHomeTeam = match.home_team || 'ä¸»é˜Ÿ';
                const mAwayTeam = match.away_team || 'å®¢é˜Ÿ';
                // å¼ºåˆ¶æ˜¾ç¤ºæ’åä»¥ä¾¿è°ƒè¯•ï¼ˆå¦‚æœæœ‰å€¼çš„è¯ï¼‰ï¼Œå¹¶ä¸”ä½¿ç”¨ç‹¬ç«‹çš„span
                const mHomeRank = showHomeRank ? `<span class="m-rank">[${match.home_rank}]</span>` : '';
                const mAwayRank = showAwayRank ? `<span class="m-rank">[${match.away_rank}]</span>` : '';

                mobileCardsArr.push(`
                    <div class="mobile-card" onclick="viewMatchDetail('${match.match_id}')">
                        <div class="m-header">
                            <div>
                                <span class="m-league">${match.league || 'æœªçŸ¥'}</span>
                                <span style="margin-left:5px;">${match.match_number || ''}</span>
                            </div>
                            <span>${match.match_time || ''}</span>
                        </div>
                        <div class="m-body">
                            <div class="m-team home">${mHomeRank}${mHomeTeam}</div>
                            <div class="m-score-box">
                                ${ (match.status === 1 || match.status === 2) ? `<div class="m-score">${score}</div>` : '' }
                                <div class="m-status">${statusText}</div>
                            </div>
                            <div class="m-team away">${mAwayRank}${mAwayTeam}</div>
                        </div>
                        <div class="m-footer">
                            <div class="m-odds-grid">
                                <!-- æ¬§èµ” -->
                                <div class="m-odds-item">
                                    <div class="m-odds-label">ç«</div>
                                    <div class="m-odds-content">
                                        <div class="m-odds-row-text"><span>åˆ: ${euroInit}</span></div>
                                        <div class="m-odds-row-text"><span>å³: ${euroCurr}</span></div>
                                        ${euroTime ? `<div style="font-size:10px;color:#a0aec0;margin-top:2px;">${euroTime}</div>` : ''}
                                    </div>
                                </div>
                                <!-- äºšç›˜ -->
                                <div class="m-odds-item">
                                    <div class="m-odds-label">äºš</div>
                                    <div class="m-odds-content">
                                        <div class="m-odds-row-text"><span>åˆ: ${asianInit}</span></div>
                                        <div class="m-odds-row-text"><span>å³: ${asianCurr}</span></div>
                                    </div>
                                </div>
                                <!-- è®©çƒ -->
                                ${ (hiHasInitial || hiHasCurrent) ? `
                                <div class="m-odds-item">
                                    <div class="m-odds-label">è®© ${hiHandicap || ''}</div>
                                    <div class="m-odds-content">
                                        ${hiHasInitial ? `<div class="m-odds-row-text"><span>åˆ: ${hiInit}</span></div>` : ''}
                                        ${hiHasCurrent ? `<div class="m-odds-row-text"><span>å³: ${hiCurr}</span></div>` : ''}
                                        ${handicapTime ? `<div style="font-size:10px;color:#a0aec0;margin-top:2px;">${handicapTime}</div>` : ''}
                                    </div>
                                </div>
                                ` : '' }
                            </div>
                            <div class="m-update-time">æ›´æ–°äº: ${formatUpdated(match.updated_at)}</div>
                             <div class="m-actions">
                                <button class="btn btn-secondary" style="padding:4px 8px; font-size:11px; background:#6b7280; color:white;" onclick="notifyTest('${match.match_id}');event.stopPropagation()">æµ‹è¯•æ¨é€</button>
                                <button class="btn btn-warning" style="padding:4px 8px; font-size:11px; background:#f59e0b; color:white;" onclick="updateMatch('${match.match_id}');event.stopPropagation()">æ›´æ–°</button>
                                <button class="btn btn-success" style="padding:4px 8px; font-size:11px; background:#667eea;" onclick="openManualPredict('${match.match_id}','${match.home_team}','${match.away_team}');event.stopPropagation()">æ‰‹åŠ¨</button>
                                <button class="btn btn-primary" style="padding:4px 8px; font-size:11px;" onclick="predictSingle('${match.match_id}');event.stopPropagation()">AI</button>
                                <a href="https://live.m.500.com/detail/football/${match.match_id}/${match.status === 0 ? 'analysis' : 'situation'}?render=local" class="btn btn-primary" style="padding:4px 8px; font-size:11px;" onclick="event.stopPropagation()">è¯¦æƒ…</a>
                             </div>
                            <div id="m-${predictionId}" class="prediction-cell" style="margin-top:5px;font-size:12px;color:#718096;text-align:right;"></div>
                        </div>
                    </div>
                `);

                return `
                    <tr onclick="viewMatchDetail('${match.match_id}')">
                        <td>
                            <div class="match-info">
                                <div class="match-num">${match.match_number || 'â€”'}</div>
                                <div class="match-league">${match.league || 'æœªçŸ¥'}</div>
                                <div class="match-datetime">${match.match_time || ''}</div>
                            </div>
                        </td>
                        <td>${homeDisplay}</td>
                        <td>${score}</td>
                        <td>${awayDisplay}</td>
                        <td><span class="status ${statusClass}">${statusText}</span></td>
                        <td>${euro}</td>
                        <td>${asian}</td>
                        <td>${ou}</td>
                        <td style="font-size:12px;">${hi}</td>
                        <td>${totalGoals}</td>
                        <td id="${predictionId}" class="prediction-cell" style="font-size:12px;color:#718096;">â€”</td>
                        <td>
                            <a href="https://live.m.500.com/detail/football/${match.match_id}/${match.status === 0 ? 'analysis' : 'situation'}?render=local" class="btn btn-primary" style="padding:3px 6px; font-size:11px;" onclick="event.stopPropagation()">è¯¦æƒ…</a>
                            <a href="https://odds.500.com/fenxi/shuju-${match.match_id}.shtml" class="btn btn-primary" style="padding:3px 6px; font-size:11px; margin-left:4px;" target="_blank" rel="noopener noreferrer" onclick="event.stopPropagation()">500</a>
                            <button class="btn btn-warning" style="padding:3px 6px; font-size:11px; margin-left:4px; background:#f59e0b; color:white;" onclick="updateMatch('${match.match_id}');event.stopPropagation()">æ›´æ–°</button>
                            <br/>
                            <button class="btn btn-success" style="padding:3px 6px; font-size:11px; margin-top:4px; background:#667eea;" onclick="openManualPredict('${match.match_id}','${match.home_team}','${match.away_team}');event.stopPropagation()">æ‰‹åŠ¨</button>
                            <button class="btn btn-primary" style="padding:3px 6px; font-size:11px; margin-top:4px; margin-left:4px;" onclick="predictSingle('${match.match_id}');event.stopPropagation()">AI</button>
                            <button class="btn btn-secondary" style="padding:3px 6px; font-size:11px; margin-top:4px; margin-left:4px; background:#6b7280; color:white;" onclick="notifyTest('${match.match_id}');event.stopPropagation()">æµ‹è¯•</button>
                        </td>
                    </tr>
                `;
            }).join('');
            
            const mobileCards = mobileCardsArr.join('');

            container.innerHTML = `
                <div class="desktop-view">
                    <div class="table-wrapper">
                        <table class="matches-table">
                        <thead>
                            <tr>
                                <th>åœºæ¬¡/è”èµ›/æ—¶é—´</th>
                                <th>ä¸»é˜Ÿ</th>
                                <th>æ¯”åˆ†/ç›˜å£</th>
                                <th>å®¢é˜Ÿ</th>
                                <th>çŠ¶æ€</th>
                                <th>æ¬§èµ”</th>
                                <th>äºšç›˜</th>
                                <th>å¤§å°çƒ</th>
                                <th>è®©çƒæŒ‡æ•°</th>
                                <th>æ€»è¿›çƒ</th>
                                <th>AIé¢„æµ‹</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${rows}
                        </tbody>
                    </table>
                    </div>
                </div>
                <div class="mobile-view">
                    ${mobileCards}
                </div>
            `;
            
            // åŠ è½½é¢„æµ‹æ•°æ®
            loadPredictions(matches);
        }
        
        // è·å–çŠ¶æ€æ ·å¼
        function getStatusClass(status) {
            if (status === 2) return 'finished';
            if (status === 1) return 'live';
            return 'upcoming';
        }
        
        // è·å–çŠ¶æ€æ–‡æœ¬
        function getStatusText(status) {
            if (status === 2) return 'å®Œåœº';
            if (status === 1) return 'è¿›è¡Œä¸­';
            return 'æœªå¼€å§‹';
        }
        
        function formatUpdated(updatedAt) {
            if (!updatedAt) return 'æœªçŸ¥';
            try {
                // å¦‚æœæ˜¯ YYYY-MM-DD æ ¼å¼ï¼ˆé€šå¸¸æ˜¯çˆ¬è™«ç›´æ¥æŠ“å–çš„æœ¬åœ°æ—¶é—´å­—ç¬¦ä¸²ï¼‰ï¼Œç›´æ¥è¿”å›
                // ç®€å•çš„æ­£åˆ™æ£€æŸ¥ï¼šä»¥4ä½æ•°å­—-2ä½æ•°å­—å¼€å¤´
                if (typeof updatedAt === 'string' && /^\d{4}-\d{2}-\d{2}/.test(updatedAt)) {
                    return updatedAt;
                }
                
                const date = new Date(updatedAt);
                // æ£€æŸ¥æ—¥æœŸæ˜¯å¦æœ‰æ•ˆ
                if (isNaN(date.getTime())) {
                    return String(updatedAt);
                }

                // ä¿®æ­£æ—¶åŒºï¼šå‡å»8å°æ—¶
                date.setHours(date.getHours() - 8);

                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                
                return `${year}-${month}-${day} ${hours}:${minutes}`;
            } catch (e) {
                return String(updatedAt);
            }
        }
        
        async function notifyTest(matchId) {
            try {
                const res = await fetch(`/api/notify_test/${matchId}`, { method: 'POST' });
                const data = await res.json();
                alert(data && data.success ? 'å·²æ¨é€' : ('æ¨é€å¤±è´¥: ' + (data && data.message ? data.message : '')));
            } catch (e) {
                alert('æ¨é€å¤±è´¥');
            }
        }
        
        // æ¸²æŸ“åˆ†é¡µå™¨
        function renderPagination(result) {
            const container = document.getElementById('paginationContainer');
            if (!result || result.total_pages <= 1) {
                container.innerHTML = '';
                return;
            }
            
            const { page, total_pages, total } = result;
            const start = (page - 1) * pageSize + 1;
            const end = Math.min(page * pageSize, total);
            
            container.innerHTML = `
                <div class="pagination">
                    <button onclick="loadMatches(1)" ${page === 1 ? 'disabled' : ''}>é¦–é¡µ</button>
                    <button onclick="loadMatches(${page - 1})" ${page === 1 ? 'disabled' : ''}>ä¸Šä¸€é¡µ</button>
                    <span class="page-info">ç¬¬ ${page} / ${total_pages} é¡µï¼Œå…± ${total} æ¡ï¼ˆæ˜¾ç¤º ${start}-${end}ï¼‰</span>
                    <button onclick="loadMatches(${page + 1})" ${page === total_pages ? 'disabled' : ''}>ä¸‹ä¸€é¡µ</button>
                    <button onclick="loadMatches(${total_pages})" ${page === total_pages ? 'disabled' : ''}>æœ«é¡µ</button>
                </div>
            `;
        }
        function showEmpty(message) {
            const container = document.getElementById('matchesContainer');
            container.innerHTML = `
                <div class="empty">
                    <div class="empty-icon">ğŸ“­</div>
                    <div class="empty-text">${message}</div>
                </div>
            `;
        }
        
        // åŠ è½½é¢„æµ‹æ•°æ®
        async function loadPredictions(matches) {
            if (!matches || matches.length === 0) return;
            
            try {
                const response = await fetch('/api/predictions?limit=200');
                const result = await response.json();
                
                if (result.success && result.data.length > 0) {
                    const predictionsMap = {};
                    result.data.forEach(pred => {
                        predictionsMap[pred.match_id] = pred;
                    });
                    
                    matches.forEach(match => {
                        const pred = predictionsMap[match.match_id];
                        if (pred) {
                            const updateCell = (cell) => {
                                if (cell) {
                                    const predText = getPredictionText(pred, match.status);
                                    const predClass = getPredictionClass(pred, match.status);
                                    cell.innerHTML = `<div class="${predClass}">${predText}</div>`;
                                    cell.onclick = (e) => {
                                        e.stopPropagation();
                                        showPredictionDetail(pred, match);
                                    };
                                }
                            };
                            updateCell(document.getElementById(`pred-${match.match_id}`));
                            updateCell(document.getElementById(`m-pred-${match.match_id}`));
                        }
                    });
                }
            } catch (error) {
                console.error('åŠ è½½é¢„æµ‹å¤±è´¥:', error);
            }
        }
        
        // è·å–é¢„æµ‹æ–‡æœ¬
        function getPredictionText(pred, status) {
            if (!pred) return 'â€”';
            
            const winMap = {'home': 'ä¸»èƒœ', 'draw': 'å¹³', 'away': 'å®¢èƒœ'};
            const asianMap = {'home': 'è®©èƒœ', 'away': 'è®©è´Ÿ'};
            const ouMap = {'over': 'å¤§çƒ', 'under': 'å°çƒ'};
            const isManual = !!(pred.manual || pred.source === 'manual' || pred.manual_option || (pred.manual_options && pred.manual_options.length));
            
            // å·²å¤ç›˜ï¼ˆå®Œåœºï¼‰çš„å±•ç¤ºï¼šæ ¹æ®é¢„æµ‹æ¥æºæ˜¾ç¤º
            if (status === 2 && pred.is_reviewed) {
                const accuracy = pred.accuracy || 0;
                const icon = accuracy >= 75 ? 'âœ…' : accuracy >= 50 ? 'âš ï¸' : 'âŒ';
                const sourceLabel = pred.is_manual ? 'æ‰‹åŠ¨' : 'AI';
                
                // æ„å»ºå¤ç›˜é¡¹ç›®æ˜¾ç¤ºï¼ˆåªæ˜¾ç¤ºæœ‰é¢„æµ‹çš„é¡¹ï¼‰
                let reviewItems = [];
                if (pred.manual_win_prediction || pred.win_prediction) {
                    reviewItems.push(`èƒœè´Ÿ${pred.win_correct ? 'âœ…' : 'âŒ'}`);
                }
                if (pred.manual_asian_prediction || pred.asian_prediction) {
                    reviewItems.push(`äºšç›˜${pred.asian_correct ? 'âœ…' : 'âŒ'}`);
                }
                if (pred.ou_prediction) {
                    reviewItems.push(`å¤§å°çƒ${pred.ou_correct ? 'âœ…' : 'âŒ'}`);
                }
                
                // è·å–ä¿¡å¿ƒæŒ‡æ•°ï¼ˆæ‰‹åŠ¨ä¼˜å…ˆï¼‰
                const winConf = pred.manual_win_confidence || pred.win_confidence || 0;
                const asianConf = pred.manual_asian_confidence || pred.asian_confidence || 0;
                const ouConf = pred.ou_confidence || 0;
                
                return `
                    <div style="line-height:1.4;">
                        <div style="font-weight:600;margin-bottom:4px;">${icon} ${sourceLabel} ${accuracy.toFixed(0)}%</div>
                        <div style="font-size:11px;color:#666;">
                            ${reviewItems.join(' ')}
                        </div>
                        <div style="font-size:11px;color:#666;margin-top:4px;">
                            ${pred.correct_count}/${pred.total_predictions}é¡¹æ­£ç¡®
                        </div>
                    </div>
                `;
            }
            
            // æœªå®Œåœºå±•ç¤ºï¼šå¦‚ä¸ºæ‰‹åŠ¨é¢„æµ‹ï¼Œä¼˜å…ˆæ˜¾ç¤ºæ‰‹åŠ¨é€‰é¡¹
            if (isManual) {
                const labelMap = { 'win': 'ä¸»èƒœ', 'draw': 'å¹³', 'lose': 'å®¢èƒœ', 'h_win': 'è®©èƒœ', 'h_draw': 'è®©å¹³', 'h_lose': 'è®©è´Ÿ' };
                const optsArr = (pred.manual_options && pred.manual_options.length) ? pred.manual_options : (pred.manual_option ? [pred.manual_option] : []);
                const manualText = optsArr.length ? optsArr.map(o => labelMap[o] || o).join(' / ') : (
                    (pred.win_prediction && winMap[pred.win_prediction]) ? winMap[pred.win_prediction] : ((pred.asian_prediction && asianMap[pred.asian_prediction]) ? asianMap[pred.asian_prediction] : 'â€”')
                );
                const handicap = pred.manual_asian_handicap || pred.asian_handicap || '';
                // è·å–æ‰‹åŠ¨ä¿¡å¿ƒæŒ‡æ•°
                const manualConf = pred.manual_win_confidence || pred.manual_asian_confidence || 90;
                // æ ¹æ®ä¿¡å¿ƒæŒ‡æ•°è®¾ç½®é¢œè‰²ï¼š90%ç»¿è‰²ï¼Œ70%æ©™è‰²ï¼Œ50%ç°è‰²
                const confColor = manualConf >= 85 ? '#38a169' : (manualConf >= 65 ? '#d69e2e' : '#718096');
                return `
                    <div style="line-height:1.5;">
                        <div style="font-weight:600;color:#667eea;margin-bottom:4px;">æ‰‹åŠ¨: ${manualText} <span style="font-size:11px;color:${confColor};font-weight:700;">${manualConf.toFixed(0)}%</span></div>
                        <div style="font-size:11px;color:#666;">
                            ${winMap[pred.win_prediction] ? ('AI: ' + winMap[pred.win_prediction] + ' ' + ((pred.win_confidence||0).toFixed(0)) + '%') : ''}
                            ${pred.asian_prediction ? ('<br>äºšç›˜: ' + (pred.asian_prediction==='home'?'è®©èƒœ':'è®©è´Ÿ') + ' (' + ((pred.asian_confidence||0).toFixed(0)) + '%)') : ''}
                            ${pred.ou_prediction ? ('<br>å¤§å°çƒ: ' + ouMap[pred.ou_prediction] + ' (' + ((pred.ou_confidence||0).toFixed(0)) + '%)') : ''}
                            ${(pred.predicted_home_score != null && pred.predicted_away_score != null) ? ('<br>æ¯”åˆ†: ' + pred.predicted_home_score + '-' + pred.predicted_away_score) : ''}
                        </div>
                    </div>
                `;
            }
            
            // é»˜è®¤AIé¢„æµ‹å±•ç¤ºï¼ˆè‡ªåŠ¨é¢„æµ‹ï¼‰
            return `
                <div style="line-height:1.5;">
                    <div style="font-weight:600;color:#667eea;margin-bottom:4px;">
                        ${winMap[pred.win_prediction] || 'â€”'} ${(pred.win_confidence||0).toFixed(0)}%
                    </div>
                    <div style="font-size:11px;color:#666;">
                        äºšç›˜: ${(asianMap[pred.asian_prediction] || 'â€”')} (${(pred.asian_confidence||0).toFixed(0)}%)<br>
                        å¤§å°çƒ: ${(ouMap[pred.ou_prediction] || 'â€”')} (${(pred.ou_confidence||0).toFixed(0)}%)<br>
                        æ¯”åˆ†: ${(pred.predicted_home_score ?? '-')}-${(pred.predicted_away_score ?? '-')}
                    </div>
                </div>
            `;
        }
        
        // è·å–é¢„æµ‹æ ·å¼ç±»
        function getPredictionClass(pred, status) {
            if (status === 2 && pred.is_reviewed) {
                const accuracy = pred.accuracy || 0;
                if (accuracy >= 75) return 'pred-success';
                if (accuracy >= 50) return 'pred-warning';
                return 'pred-fail';
            }
            return 'pred-pending';
        }
        
        // æ˜¾ç¤ºé¢„æµ‹è¯¦æƒ…å¼¹çª—
        function showPredictionDetail(pred, match) {
            const winMap = {'home': 'ä¸»èƒœ', 'draw': 'å¹³å±€', 'away': 'å®¢èƒœ'};
            const asianMap = {'home': 'ä¸»é˜Ÿ', 'away': 'å®¢é˜Ÿ'};
            const ouMap = {'over': 'å¤§çƒ', 'under': 'å°çƒ'};
            const isManual = !!(pred.manual || pred.source === 'manual');
            const titleIcon = isManual ? 'ğŸ‘' : 'ğŸ¤–';
            const titleText = isManual ? 'æ‰‹åŠ¨é¢„æµ‹è¯¦æƒ…' : 'AIé¢„æµ‹è¯¦æƒ…';
            
            let html = `
                <div style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:1000;display:flex;align-items:center;justify-content:center;" onclick="this.remove()">
                    <div style="background:white;padding:30px;border-radius:15px;max-width:500px;width:90%;max-height:80vh;overflow-y:auto;" onclick="event.stopPropagation()">
                        <h2 style="margin:0 0 20px 0;color:#333;">${titleIcon} ${titleText}</h2>
                        <div style="border-bottom:2px solid #f0f0f0;padding-bottom:15px;margin-bottom:15px;">
                            <div style="font-size:18px;font-weight:bold;">${match.home_team} vs ${match.away_team}</div>
                            <div style="color:#718096;margin-top:5px;">${match.league} - ${match.match_time}</div>
                        </div>
                        
                        <div style="margin-bottom:20px;">
                            <div style="font-weight:600;margin-bottom:10px;color:#4a5568;">ğŸ“Š é¢„æµ‹ç»“æœ</div>
                            <div style="background:#f7fafc;padding:15px;border-radius:8px;">
            `;
            
            // æ˜¾ç¤ºé¢„æµ‹é¡¹ï¼ˆæ‰‹åŠ¨/AIè‡ªé€‚åº”ï¼‰
            const winPred = pred.manual_win_prediction || pred.win_prediction;
            const winConf = pred.manual_win_confidence || pred.win_confidence;
            if (winPred) {
                html += `<div style="margin:8px 0;">èƒœè´Ÿ: <strong>${winMap[winPred]}</strong> (ç½®ä¿¡åº¦ ${(winConf||0).toFixed(1)}%)</div>`;
            }
            
            const asianPred = pred.manual_asian_prediction || pred.asian_prediction;
            const asianConf = pred.manual_asian_confidence || pred.asian_confidence;
            const asianHandicap = pred.manual_asian_handicap || pred.asian_handicap;
            if (asianPred) {
                html += `<div style="margin:8px 0;">äºšç›˜: <strong>${asianMap[asianPred]}</strong> ${asianHandicap || ''} (ç½®ä¿¡åº¦ ${(asianConf||0).toFixed(1)}%)</div>`;
            }
            
            if (pred.ou_prediction) {
                html += `<div style="margin:8px 0;">å¤§å°çƒ: <strong>${ouMap[pred.ou_prediction]}</strong> ${pred.ou_total || ''} (ç½®ä¿¡åº¦ ${(pred.ou_confidence||0).toFixed(1)}%)</div>`;
            }
            
            if (pred.predicted_home_score != null && pred.predicted_away_score != null) {
                html += `<div style="margin:8px 0;">æ¯”åˆ†: <strong>${pred.predicted_home_score}-${pred.predicted_away_score}</strong></div>`;
            }
            
            html += `
                            </div>
                        </div>
            `;
            
            // å¦‚æœå·²å¤ç›˜ï¼Œæ˜¾ç¤ºå¤ç›˜ç»“æœ
            if (match.status === 2 && pred.is_reviewed) {
                html += `
                    <div style="margin-bottom:20px;">
                        <div style="font-weight:600;margin-bottom:10px;color:#4a5568;">ğŸ“ˆ å¤ç›˜ç»“æœ</div>
                        <div style="background:#f7fafc;padding:15px;border-radius:8px;">
                            <div style="margin:8px 0;">å®é™…æ¯”åˆ†: <strong>${pred.actual_home_score}-${pred.actual_away_score}</strong></div>
                            <div style="margin:8px 0;">æ€»ä½“å‡†ç¡®åº¦: <strong style="color:${pred.accuracy >= 75 ? '#48bb78' : pred.accuracy >= 50 ? '#f6ad55' : '#fc8181'};">${pred.accuracy.toFixed(1)}%</strong></div>
                            <div style="margin:8px 0;font-size:14px;">
                                ${pred.correct_count}/${pred.total_predictions} é¡¹æ­£ç¡®
                            </div>
                            <div style="margin:8px 0;font-size:14px;">
                `;
                
                // åªæ˜¾ç¤ºæœ‰é¢„æµ‹çš„é¡¹
                if (winPred) {
                    html += `èƒœè´Ÿé¢„æµ‹ ${pred.win_correct ? 'âœ…' : 'âŒ'} `;
                }
                if (asianPred) {
                    html += `äºšç›˜é¢„æµ‹ ${pred.asian_correct ? 'âœ…' : 'âŒ'} `;
                }
                if (pred.ou_prediction) {
                    html += `å¤§å°çƒé¢„æµ‹ ${pred.ou_correct ? 'âœ…' : 'âŒ'}`;
                }
                
                html += `
                            </div>
                        </div>
                    </div>
                `;
            }
            
            html += `
                        <button onclick="this.parentElement.parentElement.remove()" style="width:100%;padding:12px;background:#667eea;color:white;border:none;border-radius:8px;cursor:pointer;font-size:15px;">å…³é—­</button>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', html);
        }
        
        // åŠ è½½è”èµ›åˆ—è¡¨
        async function loadLeagues() {
            try {
                const response = await fetch('/api/leagues');
                const result = await response.json();
                
                if (result.success && result.data.length > 0) {
                    const select = document.getElementById('leagueFilter');
                    result.data.forEach(league => {
                        const option = document.createElement('option');
                        option.value = league;
                        option.textContent = league;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('åŠ è½½è”èµ›åˆ—è¡¨å¤±è´¥:', error);
            }
        }
        
        
        // çˆ¬å–æ–°æ•°æ®
        async function crawlNewData() {
            const btn = event.target;
            btn.disabled = true;
            btn.textContent = 'çˆ¬å–ä¸­...';
            const logsEl = document.getElementById('crawlLogs');
            if (logsEl) { logsEl.innerHTML = ''; }
            try {
                const date = document.getElementById('datePicker').value;
                const url = '/api/crawl_stream' + (date ? ('?date=' + encodeURIComponent(date)) : '');
                const es = new EventSource(url);
                es.onmessage = (e) => {
                    if (logsEl) {
                        const line = document.createElement('div');
                        line.textContent = e.data;
                        logsEl.appendChild(line);
                        logsEl.scrollTop = logsEl.scrollHeight;
                    }
                };
                es.addEventListener('done', (e) => {
                    if (logsEl) {
                        const line = document.createElement('div');
                        line.textContent = 'ä»»åŠ¡ç»“æŸ: ' + e.data;
                        logsEl.appendChild(line);
                    }
                    es.close();
                    btn.disabled = false;
                    btn.textContent = 'ğŸ“¥ çˆ¬å–æ–°æ•°æ®';
                    loadMatches();
                });
                es.onerror = () => {
                    if (logsEl) {
                        const line = document.createElement('div');
                        line.textContent = 'è¿æ¥ä¸­æ–­æˆ–å‘ç”Ÿé”™è¯¯';
                        logsEl.appendChild(line);
                    }
                    es.close();
                    btn.disabled = false;
                    btn.textContent = 'ğŸ“¥ çˆ¬å–æ–°æ•°æ®';
                };
            } catch (error) {
                if (logsEl) {
                    const line = document.createElement('div');
                    line.textContent = 'åˆå§‹åŒ–å¤±è´¥: ' + error.message;
                    logsEl.appendChild(line);
                }
                btn.disabled = false;
                btn.textContent = 'ğŸ“¥ çˆ¬å–æ–°æ•°æ®';
            }
        }
        
        // æŸ¥çœ‹æ¯”èµ›è¯¦æƒ…
        function viewMatchDetail(matchId) {
            window.location.href = `/match/${matchId}`;
        }
        
        // ç­›é€‰äº‹ä»¶
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('leagueFilter').addEventListener('change', () => loadMatches(1));
            document.getElementById('statusFilter').addEventListener('change', () => loadMatches(1));
        });
        
        
        // æ˜¾ç¤ºæ¨èå¼¹çª—
        function showRecommendationModal(data) {
            const typeMap = {'ä¸»èƒœ': 'ğŸ  ä¸»èƒœ', 'å®¢èƒœ': 'âœˆï¸ å®¢èƒœ', 'å¤§çƒ': 'âš½ å¤§çƒ'};
            
            let selectionsHtml = data.selections.map((s, idx) => `
                <div style="background:#f7fafc;padding:15px;border-radius:10px;margin-bottom:12px;border-left:4px solid #667eea;">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                        <span style="font-weight:600;color:#667eea;">å…³å¡${idx+1}</span>
                        <span style="background:#667eea;color:white;padding:3px 10px;border-radius:15px;font-size:12px;">${s.league}</span>
                    </div>
                    <div style="font-size:16px;font-weight:bold;margin-bottom:6px;">${s.home_team} vs ${s.away_team}</div>
                    <div style="font-size:13px;color:#718096;margin-bottom:8px;">â° ${s.match_time}</div>
                    <div style="display:flex;justify-content:space-between;align-items:center;">
                        <span style="font-size:15px;font-weight:600;color:#48bb78;">${typeMap[s.type] || s.type}</span>
                        <span style="font-size:18px;font-weight:bold;color:#e53e3e;">@ ${s.odds.toFixed(2)}</span>
                    </div>
                    <div style="font-size:12px;color:#718096;margin-top:8px;padding-top:8px;border-top:1px dashed #e2e8f0;">
                        ğŸ“Š ${s.reason}
                    </div>
                </div>
            `).join('');
            
            const html = `
                <div id="recommendModal" style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.6);z-index:1000;display:flex;align-items:center;justify-content:center;" onclick="this.remove()">
                    <div style="background:white;padding:30px;border-radius:20px;max-width:500px;width:90%;max-height:85vh;overflow-y:auto;box-shadow:0 25px 50px rgba(0,0,0,0.3);" onclick="event.stopPropagation()">
                        <div style="text-align:center;margin-bottom:25px;">
                            <div style="font-size:40px;margin-bottom:10px;">ğŸ¯</div>
                            <h2 style="margin:0;color:#2d3748;font-size:24px;">AIæ™ºèƒ½æ¨è</h2>
                            <div style="color:#718096;margin-top:8px;">${data.n}ä¸²1 Â· ç›®æ ‡èµ”ç‡ ${data.target_odds}</div>
                        </div>
                        
                        <div style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);color:white;padding:20px;border-radius:12px;margin-bottom:20px;text-align:center;">
                            <div style="font-size:14px;opacity:0.9;">é¢„è®¡æ€»èµ”ç‡</div>
                            <div style="font-size:36px;font-weight:bold;">${data.actual_odds.toFixed(2)}</div>
                            <div style="font-size:13px;opacity:0.8;margin-top:5px;">æŠ•100å…ƒ â†’ å›æŠ¥${(data.actual_odds * 100).toFixed(0)}å…ƒ</div>
                        </div>
                        
                        <div style="margin-bottom:20px;">
                            ${selectionsHtml}
                        </div>
                        
                        <div style="background:#fff3cd;padding:12px;border-radius:8px;margin-bottom:20px;font-size:13px;color:#856404;">
                            âš ï¸ é£é™©æç¤ºï¼šç«æŠ€ä½“è‚²æ— ç»å¯¹ï¼Œä»¥ä¸Šæ¨èä»…ä¾›å‚è€ƒï¼Œè¯·ç†æ€§æŠ•æ³¨ã€‚
                        </div>
                        
                        <button onclick="document.getElementById('recommendModal').remove()" style="width:100%;padding:14px;background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);color:white;border:none;border-radius:10px;cursor:pointer;font-size:16px;font-weight:600;">
                            çŸ¥é“äº†
                        </button>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', html);
        }
    
            // æ‰¹é‡å¤ç›˜å·²å®Œåœºä¸”æœ‰é¢„æµ‹çš„æ¯”èµ›
            async function predictUpcoming() {
                const btn = event.target;
                if (btn) { btn.disabled = true; btn.textContent = 'é¢„æµ‹ä¸­...'; }
                try {
                    const upcomingIds = (allMatches || []).filter(m => m.status === 0).map(m => m.match_id);
                    if (!upcomingIds || upcomingIds.length === 0) {
                        alert('å½“å‰æ— æœªå¼€å§‹çš„æ¯”èµ›');
                        return;
                    }
                    let successCount = 0, failCount = 0;
                    for (const mid of upcomingIds) {
                        try {
                            const res = await fetch(`/api/predict/${mid}`);
                            const j = await res.json();
                            if (j.success) successCount += 1; else failCount += 1;
                        } catch (e) {
                            failCount += 1;
                        }
                    }
                    alert(`é¢„æµ‹å®Œæˆï¼šæˆåŠŸ ${successCount} åœºï¼Œå¤±è´¥ ${failCount} åœº`);
                    await loadMatches(currentPage);
                } catch (e) {
                    console.error('é¢„æµ‹è¯·æ±‚å¤±è´¥:', e);
                    alert('é¢„æµ‹è¯·æ±‚å¤±è´¥ï¼š' + e.message);
                } finally {
                    if (btn) { btn.disabled = false; btn.textContent = 'ğŸ¤– é¢„æµ‹æœªå¼€å§‹'; }
                }
            }
            function openManualPredict(matchId, homeTeam, awayTeam) {
                // ä»allMatchesä¸­æŸ¥æ‰¾æ¯”èµ›æ•°æ®è·å–èµ”ç‡
                const match = (allMatches || []).find(m => m.match_id === matchId) || {};
                
// æ¬§èµ”ï¼ˆå­—æ®µå·²ä¿®æ­£ï¼šinitialæ˜¯åˆç›˜ï¼Œcurrentæ˜¯å³æ—¶ï¼‰
                                const euroWin = match.euro_current_win || match.euro_initial_win || 'â€”';
                                const euroDraw = match.euro_current_draw || match.euro_initial_draw || 'â€”';
                                const euroLose = match.euro_current_lose || match.euro_initial_lose || 'â€”';
                
                // äºšç›˜
                const asianHome = match.asian_current_home_odds || match.asian_initial_home_odds || 'â€”';
                const asianHandicap = match.asian_current_handicap || match.asian_initial_handicap || 'â€”';
                const asianAway = match.asian_current_away_odds || match.asian_initial_away_odds || 'â€”';
                
                // è®©çƒæŒ‡æ•°
                const hiHandicap = match.hi_handicap_value || 'â€”';
                const hiHome = match.hi_current_home_odds || match.hi_initial_home_odds || 'â€”';
                const hiDraw = match.hi_current_draw_odds || match.hi_initial_draw_odds || 'â€”';
                const hiAway = match.hi_current_away_odds || match.hi_initial_away_odds || 'â€”';
                
                const overlay = document.createElement('div');
                overlay.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:1000;display:flex;align-items:center;justify-content:center;';
                overlay.id = 'manualPredictOverlay';
                overlay.onclick = () => overlay.remove();
                const box = document.createElement('div');
                box.style.cssText = 'background:white;padding:20px 24px;border-radius:12px;max-width:560px;width:90%;box-shadow:0 10px 30px rgba(0,0,0,0.2);max-height:90vh;overflow-y:auto;';
                box.onclick = (e) => e.stopPropagation();
                box.innerHTML = `
                    <div style="font-size:18px;font-weight:700;color:#2d3748;margin-bottom:12px;">æ‰‹åŠ¨é¢„æµ‹ - ${homeTeam} vs ${awayTeam}</div>
                    
                    <div style="background:#f7fafc;border-radius:8px;padding:12px;margin-bottom:12px;">
                        <div style="font-weight:600;color:#4a5568;margin-bottom:8px;font-size:13px;">ğŸ“Š èµ”ç‡å‚è€ƒ</div>
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:12px;">
                            <div style="background:white;padding:8px;border-radius:6px;">
                                <div style="color:#718096;margin-bottom:4px;">æ¬§èµ” (ä¸»/å¹³/å®¢)</div>
                                <div style="font-weight:600;color:#667eea;">${euroWin} / ${euroDraw} / ${euroLose}</div>
                            </div>
                            <div style="background:white;padding:8px;border-radius:6px;">
                                <div style="color:#718096;margin-bottom:4px;">äºšç›˜</div>
                                <div style="font-weight:600;color:#667eea;">${asianHome} / ${asianHandicap} / ${asianAway}</div>
                            </div>
                            <div style="background:white;padding:8px;border-radius:6px;grid-column:span 2;">
                                <div style="color:#718096;margin-bottom:4px;">è®©çƒæŒ‡æ•° (${hiHandicap})</div>
                                <div style="font-weight:600;color:#667eea;">ä¸»èƒœ ${hiHome} / å¹³ ${hiDraw} / å®¢èƒœ ${hiAway}</div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-bottom:12px;">
                        <div style="font-weight:600;color:#4a5568;margin-bottom:8px;">é€‰æ‹©é¢„æµ‹ç»“æœï¼š</div>
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
                            <label style="display:flex;align-items:center;gap:8px;font-size:14px;"><input type="checkbox" data-option="win"> ä¸»èƒœ <span style="color:#667eea;font-size:12px;">${euroWin}</span></label>
                            <label style="display:flex;align-items:center;gap:8px;font-size:14px;"><input type="checkbox" data-option="draw"> å¹³ <span style="color:#667eea;font-size:12px;">${euroDraw}</span></label>
                            <label style="display:flex;align-items:center;gap:8px;font-size:14px;"><input type="checkbox" data-option="lose"> å®¢èƒœ <span style="color:#667eea;font-size:12px;">${euroLose}</span></label>
                            <label style="display:flex;align-items:center;gap:8px;font-size:14px;"><input type="checkbox" data-option="h_win"> è®©èƒœ <span style="color:#667eea;font-size:12px;">${hiHome}</span></label>
                            <label style="display:flex;align-items:center;gap:8px;font-size:14px;"><input type="checkbox" data-option="h_draw"> è®©å¹³ <span style="color:#667eea;font-size:12px;">${hiDraw}</span></label>
                            <label style="display:flex;align-items:center;gap:8px;font-size:14px;"><input type="checkbox" data-option="h_lose"> è®©è´Ÿ <span style="color:#667eea;font-size:12px;">${hiAway}</span></label>
                        </div>
                    </div>
                    <div style="margin-bottom:12px;">
                        <div style="font-weight:600;color:#4a5568;margin-bottom:8px;">ä¿¡å¿ƒæŒ‡æ•°ï¼š</div>
                        <div style="display:flex;gap:10px;">
                            <label style="flex:1;display:flex;align-items:center;justify-content:center;gap:6px;padding:8px;border:2px solid #e2e8f0;border-radius:6px;cursor:pointer;" onclick="this.querySelector('input').checked=true;">
                                <input type="radio" name="confidence" value="90" checked> <span style="font-weight:600;color:#38a169;">90%</span>
                            </label>
                            <label style="flex:1;display:flex;align-items:center;justify-content:center;gap:6px;padding:8px;border:2px solid #e2e8f0;border-radius:6px;cursor:pointer;" onclick="this.querySelector('input').checked=true;">
                                <input type="radio" name="confidence" value="70"> <span style="font-weight:600;color:#d69e2e;">70%</span>
                            </label>
                            <label style="flex:1;display:flex;align-items:center;justify-content:center;gap:6px;padding:8px;border:2px solid #e2e8f0;border-radius:6px;cursor:pointer;" onclick="this.querySelector('input').checked=true;">
                                <input type="radio" name="confidence" value="50"> <span style="font-weight:600;color:#718096;">50%</span>
                            </label>
                        </div>
                    </div>
                    <div style="text-align:right;display:flex;justify-content:flex-end;gap:10px;">
                        <button class="btn btn-primary" onclick="this.closest('div').parentNode.remove()">å–æ¶ˆ</button>
                        <button class="btn btn-success" onclick="(function(btn){
                            const box = btn.closest('div').parentNode;
                            const opts = Array.from(box.querySelectorAll('input[type=checkbox][data-option]:checked')).map(i=>i.getAttribute('data-option'));
                            const conf = box.querySelector('input[name=confidence]:checked');
                            const confidence = conf ? parseFloat(conf.value) : 90;
                            submitManualPredict('${matchId}', opts, confidence);
                        })(this);">ç¡®å®š</button>
                    </div>
                `;
                overlay.appendChild(box);
                document.body.appendChild(overlay);
            }
            async function submitManualPredict(matchId, options, confidence) {
                try {
                    const deviceId = getDeviceId();
                    const res = await fetch(`/api/predict/manual/${matchId}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ options, confidence, device_id: deviceId })
                    });
                    const j = await res.json();
                    if (j.success) {
                        await loadMatches(currentPage);
                        const overlay = document.getElementById('manualPredictOverlay') || document.querySelector('body > div[style*="position:fixed"][style*="z-index:1000"]');
                        if (overlay) overlay.remove();
                    } else {
                        alert('ä¿å­˜å¤±è´¥ï¼š' + (j.message || 'æœªçŸ¥é”™è¯¯'));
                    }
                } catch (e) {
                    alert('è¯·æ±‚å¤±è´¥ï¼š' + e.message);
                }
            }
            async function predictSingle(matchId) {
                const btn = event ? event.target : null;
                if (btn) { btn.disabled = true; btn.textContent = 'é¢„æµ‹ä¸­...'; }
                try {
                    const res = await fetch(`/api/predict/${matchId}`);
                    const j = await res.json();
                    if (j.success) {
                        alert('AIé¢„æµ‹ç”ŸæˆæˆåŠŸ');
                        await loadMatches(currentPage);
                    } else {
                        alert('é¢„æµ‹å¤±è´¥ï¼š' + (j.message || 'æœªçŸ¥é”™è¯¯'));
                    }
                } catch (e) {
                    alert('è¯·æ±‚å¤±è´¥ï¼š' + e.message);
                } finally {
                    if (btn) { btn.disabled = false; btn.textContent = 'AIé¢„æµ‹'; }
                }
            }
            async function updateMatch(matchId) {
                const btn = event ? event.target : null;
                if (btn) { btn.disabled = true; btn.textContent = 'æ›´æ–°ä¸­...'; }
                try {
                    const res = await fetch(`/api/crawl_odds/${matchId}`);
                    const j = await res.json();
                    if (j.success) {
                        alert('æ•°æ®æ›´æ–°æˆåŠŸ');
                        await loadMatches(currentPage);
                    } else {
                        alert('æ›´æ–°å¤±è´¥ï¼š' + (j.message || 'æœªçŸ¥é”™è¯¯'));
                    }
                } catch (e) {
                    alert('è¯·æ±‚å¤±è´¥ï¼š' + e.message);
                } finally {
                    if (btn) { btn.disabled = false; btn.textContent = 'æ›´æ–°'; }
                }
            }
            async function reviewFinished() {
                try {
                    const predsRes = await fetch('/api/predictions?is_reviewed=false&limit=200');
                    const predsJson = await predsRes.json();
                    if (!predsJson.success || !predsJson.data || predsJson.data.length === 0) {
                        alert('æš‚æ— æœªå¤ç›˜çš„é¢„æµ‹æ•°æ®');
                        return;
                    }
                    const preds = predsJson.data;
                    const finishedIds = new Set((allMatches || []).filter(m => m.status === 2).map(m => m.match_id));
                    const reviewIds = preds.map(p => p.match_id).filter(id => finishedIds.has(id));
                    if (reviewIds.length === 0) {
                        alert('å½“å‰é¡µé¢æ²¡æœ‰ã€å·²å®Œåœºä¸”æœ‰é¢„æµ‹ã€‘çš„æ¯”èµ›éœ€è¦å¤ç›˜');
                        return;
                    }
                    let successCount = 0, failCount = 0;
                    for (const mid of reviewIds) {
                        try {
                            const res = await fetch(`/api/review/${mid}`);
                            const j = await res.json();
                            if (j.success) successCount += 1;
                            else { failCount += 1; console.warn('å¤ç›˜å¤±è´¥', mid, j.message); }
                        } catch (e) {
                            failCount += 1; console.error('å¤ç›˜å¼‚å¸¸', mid, e);
                        }
                    }
                    alert(`å¤ç›˜å®Œæˆï¼šæˆåŠŸ ${successCount} åœºï¼Œå¤±è´¥ ${failCount} åœº`);
                    await loadMatches(currentPage);
                } catch (e) {
                    console.error('å¤ç›˜è¯·æ±‚å¤±è´¥:', e);
                    alert('å¤ç›˜è¯·æ±‚å¤±è´¥ï¼š' + e.message);
                }
            }




            // æˆ‘çš„é€‰æ‹©åŠŸèƒ½
            async function showMyPicks() {
                try {
                    const res = await fetch('/api/my_picks');
                    const data = await res.json();
                    
                    if (!data.success) {
                        alert(data.message || 'è·å–æ•°æ®å¤±è´¥');
                        return;
                    }
                    
                    if (data.count === 0) {
                        alert('æš‚æ— æ‰‹åŠ¨æ ‡è®°çš„æœªå¼€å§‹æ¯”èµ›ã€‚\nè¯·å…ˆåœ¨æ¯”èµ›åˆ—è¡¨ä¸­ç‚¹å‡»ã€Œæ‰‹åŠ¨ã€æŒ‰é’®è¿›è¡Œæ ‡è®°ã€‚');
                        return;
                    }
                    
                    showMyPicksModal(data.data);
                } catch (e) {
                    alert('è¯·æ±‚å¤±è´¥: ' + e.message);
                }
            }
            
            function showMyPicksModal(picks) {
                // ç”Ÿæˆæ¯”èµ›è¡Œï¼ˆå¸¦å¤é€‰æ¡†ï¼‰
                const rows = picks.map((p, i) => {
                    const confColor = p.confidence >= 85 ? '#38a169' : (p.confidence >= 65 ? '#d69e2e' : '#718096');
                    const oddsDisplay = p.main_odds ? p.main_odds.toFixed(2) : '-';
                    
                    return `
                        <tr style="border-bottom:1px solid #eee;" data-match='${JSON.stringify(p).replace(/'/g, "&#39;")}'>
                            <td style="padding:10px 8px;text-align:center;">
                                <input type="checkbox" class="pick-checkbox" data-idx="${i}" data-odds="${p.main_odds || 1}" checked style="width:18px;height:18px;cursor:pointer;">
                            </td>
                            <td style="padding:10px 8px;font-size:12px;">
                                <div style="font-weight:600;color:#667eea;">${p.league}</div>
                                <div style="color:#718096;font-size:11px;">${p.match_time}</div>
                            </td>
                            <td style="padding:10px 8px;font-size:13px;">
                                <div style="font-weight:600;">${p.home_team}</div>
                                <div style="color:#718096;">vs ${p.away_team}</div>
                            </td>
                            <td style="padding:10px 8px;text-align:center;">
                                <div style="font-weight:700;color:#667eea;font-size:14px;">${p.options_text.join(' / ')}</div>
                                <div style="font-size:11px;color:${confColor};margin-top:2px;">${p.confidence}%</div>
                            </td>
                            <td style="padding:10px 8px;text-align:center;font-size:12px;">
                                <div style="color:#718096;font-size:10px;">æ¬§èµ”</div>
                                <div>${p.euro_odds}</div>
                            </td>
                            <td style="padding:10px 8px;text-align:center;font-size:12px;">
                                <div style="color:#718096;font-size:10px;">è®©çƒ(${p.hi_handicap || '-'})</div>
                                <div>${p.hi_odds}</div>
                            </td>
                            <td style="padding:10px 8px;text-align:center;">
                                <span style="font-size:18px;font-weight:700;color:#e53e3e;">${oddsDisplay}</span>
                            </td>
                        </tr>
                    `;
                }).join('');
                
                const html = `
                    <div id="myPicksModal" style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.6);z-index:1000;display:flex;align-items:center;justify-content:center;padding:20px;" onclick="this.remove()">
                        <div style="background:white;border-radius:16px;max-width:1000px;width:100%;max-height:90vh;overflow:hidden;box-shadow:0 25px 50px rgba(0,0,0,0.3);display:flex;flex-direction:column;" onclick="event.stopPropagation()">
                            
                            <!-- å¤´éƒ¨ -->
                            <div style="background:linear-gradient(135deg, #00b09b 0%, #96c93d 100%);color:white;padding:18px 25px;">
                                <div style="display:flex;justify-content:space-between;align-items:center;">
                                    <div>
                                        <div style="font-size:20px;font-weight:700;">ğŸ¯ æˆ‘çš„é€‰æ‹©</div>
                                        <div style="font-size:13px;opacity:0.9;margin-top:4px;">å…± ${picks.length} åœºæ‰‹åŠ¨æ ‡è®°</div>
                                    </div>
                                    <button onclick="document.getElementById('myPicksModal').remove()" style="background:rgba(255,255,255,0.2);border:none;color:white;width:32px;height:32px;border-radius:50%;cursor:pointer;font-size:16px;">âœ•</button>
                                </div>
                            </div>
                            
                            <!-- ç»„åˆè®¡ç®—åŒº -->
                            <div style="background:#f7fafc;padding:15px 25px;border-bottom:1px solid #e2e8f0;">
                                <div style="display:flex;gap:20px;align-items:center;flex-wrap:wrap;">
                                    <div>
                                        <span style="color:#718096;font-size:13px;">å·²é€‰ï¼š</span>
                                        <span id="selectedCount" style="font-weight:700;color:#667eea;font-size:16px;">${picks.length}</span>
                                        <span style="color:#718096;font-size:13px;"> åœº</span>
                                    </div>
                                    <div>
                                        <span style="color:#718096;font-size:13px;">ç»„åˆèµ”ç‡ï¼š</span>
                                        <span id="totalOdds" style="font-weight:700;color:#e53e3e;font-size:20px;">-</span>
                                    </div>
                                    <div>
                                        <span style="color:#718096;font-size:13px;">æŠ•100å…ƒå›æŠ¥ï¼š</span>
                                        <span id="returnAmount" style="font-weight:700;color:#38a169;font-size:16px;">-</span>
                                        <span style="color:#718096;font-size:13px;"> å…ƒ</span>
                                    </div>
                                    <div style="margin-left:auto;">
                                        <button onclick="selectAllPicks(true)" style="padding:6px 12px;background:#667eea;color:white;border:none;border-radius:6px;cursor:pointer;font-size:12px;margin-right:8px;">å…¨é€‰</button>
                                        <button onclick="selectAllPicks(false)" style="padding:6px 12px;background:#e2e8f0;color:#4a5568;border:none;border-radius:6px;cursor:pointer;font-size:12px;">å–æ¶ˆå…¨é€‰</button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- æ¯”èµ›åˆ—è¡¨ -->
                            <div style="flex:1;overflow-y:auto;padding:15px 25px;">
                                <table style="width:100%;border-collapse:collapse;font-size:13px;">
                                    <thead>
                                        <tr style="background:#f7fafc;">
                                            <th style="padding:10px 8px;text-align:center;font-weight:600;color:#4a5568;width:40px;">é€‰</th>
                                            <th style="padding:10px 8px;text-align:left;font-weight:600;color:#4a5568;">æ¯”èµ›</th>
                                            <th style="padding:10px 8px;text-align:left;font-weight:600;color:#4a5568;">å¯¹é˜µ</th>
                                            <th style="padding:10px 8px;text-align:center;font-weight:600;color:#4a5568;">æˆ‘çš„é€‰æ‹©</th>
                                            <th style="padding:10px 8px;text-align:center;font-weight:600;color:#4a5568;">æ¬§èµ”</th>
                                            <th style="padding:10px 8px;text-align:center;font-weight:600;color:#4a5568;">è®©çƒæŒ‡æ•°</th>
                                            <th style="padding:10px 8px;text-align:center;font-weight:600;color:#4a5568;">èµ”ç‡</th>
                                        </tr>
                                    </thead>
                                    <tbody id="picksTableBody">
                                        ${rows}
                                    </tbody>
                                </table>
                            </div>
                            
                            <!-- æ¨èç»„åˆ -->
                            <div style="background:#fff3cd;padding:12px 25px;border-top:1px solid #ffeeba;">
                                <div style="font-size:13px;color:#856404;">
                                    ğŸ’¡ å»ºè®®ï¼šé€‰æ‹©2-4åœºé«˜ç½®ä¿¡åº¦æ¯”èµ›ç»„æˆä¸²å…³ï¼Œæ§åˆ¶æ€»èµ”ç‡åœ¨3-8å€ä¹‹é—´ã€‚
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', html);
                
                // ç»‘å®šäº‹ä»¶å¹¶è®¡ç®—åˆå§‹èµ”ç‡
                setTimeout(() => {
                    document.querySelectorAll('.pick-checkbox').forEach(cb => {
                        cb.addEventListener('change', calculateTotalOdds);
                    });
                    calculateTotalOdds();
                }, 100);
            }
            
            function selectAllPicks(select) {
                document.querySelectorAll('.pick-checkbox').forEach(cb => {
                    cb.checked = select;
                });
                calculateTotalOdds();
            }
            
            function calculateTotalOdds() {
                const checkboxes = document.querySelectorAll('.pick-checkbox:checked');
                let totalOdds = 1;
                let count = 0;
                
                checkboxes.forEach(cb => {
                    const odds = parseFloat(cb.dataset.odds);
                    if (odds && odds > 0) {
                        totalOdds *= odds;
                        count++;
                    }
                });
                
                const selectedCountEl = document.getElementById('selectedCount');
                const totalOddsEl = document.getElementById('totalOdds');
                const returnAmountEl = document.getElementById('returnAmount');
                
                if (selectedCountEl) selectedCountEl.textContent = count;
                
                if (count > 0) {
                    if (totalOddsEl) totalOddsEl.textContent = totalOdds.toFixed(2);
                    if (returnAmountEl) returnAmountEl.textContent = (totalOdds * 100).toFixed(0);
                } else {
                    if (totalOddsEl) totalOddsEl.textContent = '-';
                    if (returnAmountEl) returnAmountEl.textContent = '-';
                }
            }
        </script>
</body>
</html>
